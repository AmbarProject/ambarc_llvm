name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number'
        required: true
        default: '1.0.0'

jobs:
  build-deb:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup LLVM 18
      run: |
        wget https://apt.llvm.org/llvm.sh
        chmod +x llvm.sh
        sudo ./llvm.sh 18
        rm llvm.sh
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          bison \
          flex \
          libstdc++6 \
          libtinfo6 \
          zlib1g \
          libffi8 \
          libedit2 \
          libxml2 \
          libncurses6 \
          libz3-4 \
          dpkg-dev
    
    - name: Build compiler
      run: |
        cd compiler
        chmod +x *.sh
        ./rm.sh
        ./ir.sh
    
    - name: Create .deb package
      run: |
        chmod +x tools/create-deb.sh
        ./tools/create-deb.sh
    
    - name: List artifacts
      run: |
        ls -la *.deb
    
    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: deb-package
        path: ambarc_*.deb
    
    - name: Create checksum
      run: |
        sha256sum ambarc_*.deb > checksum.txt
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ambarc_*.deb
          checksum.txt
        generate_release_notes: true